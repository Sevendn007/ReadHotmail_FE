<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lấy 3 email mới nhất & mã Facebook — ReadHotmail</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#2563eb;
      --success:#10b981;
      --danger:#ef4444;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#f8fafc 0%, #f0f4f8 100%);color:#0f172a}
    .wrap{max-width:980px;margin:36px auto;padding:28px}
    .panel{
      background:var(--card);
      border-radius:14px;
      padding:20px;
      box-shadow: 0 8px 30px rgba(15,23,42,0.08);
      border: 1px solid rgba(15,23,42,0.04);
    }
    .header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px;
    }
    .title{font-size:1.25rem;font-weight:700}
    .sub{color:var(--muted);font-size:0.9rem}
    .controls{display:flex;gap:10px;align-items:center}
    .btn{
      background:var(--accent);color:white;padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer;
      box-shadow:0 6px 18px rgba(37,99,235,0.16);font-size:0.9rem;
    }
    .btn-small{padding:8px 12px;font-size:0.85rem;}
    .btn:disabled{opacity:0.6;cursor:not-allowed}
    .logout{
      background:#fff;border:1px solid rgba(15,23,42,0.06);padding:8px 12px;border-radius:10px;cursor:pointer;
      font-size:0.8rem;
    }

    /* login overlay */
    .overlay{
      position:fixed;inset:0;background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.55));
      display:flex;align-items:center;justify-content:center;z-index:60;
    }
    .login-card{
      width:420px;background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96));
      border-radius:12px;padding:20px 22px;box-shadow:0 18px 50px rgba(2,6,23,0.48);
      border:1px solid rgba(2,6,23,0.06);
    }
    label{display:block;font-size:0.85rem;margin-bottom:6px;color:#0f172a;font-weight:600}
    input[type="text"], input[type="password"]{
      width:100%;padding:10px 12px;border-radius:8px;border:1px solid #e6eef8;background:#fff;font-size:0.95rem;
    }

    /* banner */
    .otp-banner{display:flex;align-items:center;gap:14px;padding:14px;border-radius:12px;margin-bottom:16px}
    .otp-banner .code{font-weight:800;font-size:1.15rem}
    .otp-banner.success{
      background:linear-gradient(90deg, rgba(16,185,129,0.08), rgba(16,185,129,0.03));
      border:1px solid rgba(16,185,129,0.12);color:var(--success)
    }
    .otp-banner.none{
      background:linear-gradient(90deg, rgba(239,68,68,0.04), rgba(239,68,68,0.01));
      border:1px solid rgba(239,68,68,0.06);color:var(--danger)
    }

    /* emails */
    .emails{display:grid;gap:12px}
    .email-card{
      background:linear-gradient(180deg, #ffffff, #fcfeff);
      border-radius:12px;padding:14px;border:1px solid rgba(15,23,42,0.04);
      box-shadow:0 10px 24px rgba(15,23,42,0.03);
    }
    .email-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .subject{font-weight:700;margin-bottom:6px}
    .meta{font-size:0.85rem;color:var(--muted);margin-bottom:8px}
    .preview{color:#0b1220;line-height:1.35;max-height:4.2em;overflow:hidden;text-overflow:ellipsis}
    .small{font-size:0.85rem;color:var(--muted)}

    @media (max-width:560px){
      .wrap{padding:14px}
      .login-card{width:92%}
      .header{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel" id="appPanel" aria-hidden="true">
      <div class="header">
        <div>
          <div class="title">3 email mới nhất</div>
          <div class="sub">Nhập 1 credential để xem 3 mail mới nhất và kiểm tra mã bảo mật Facebook.</div>
        </div>
        <div class="controls">
          <button id="newCredBtn" class="btn btn-small" style="display:none;">Nhập credential</button>
          <button id="logoutBtn" class="logout" style="display:none;">Logout</button>
        </div>
      </div>

      <div id="otpBannerWrap" style="margin-bottom:6px"></div>
      <div id="emailsWrap" class="emails"></div>

      <p class="small" style="margin-top:16px">
        * Double-click vào vùng trắng hoặc bấm <strong>“Nhập credential”</strong> để nhập lại dòng
        <code>Username|Password|access_token|refresh_token|Client_id|Proxy</code>.
      </p>
    </div>
  </div>

  <!-- Login -->
  <div id="loginOverlay" class="overlay" style="display:flex">
    <div class="login-card" role="dialog" aria-modal="true" aria-label="Login">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div>
          <div style="font-weight:800;font-size:1.05rem">Đăng nhập</div>
          <div class="small">Nhập username & password để truy cập trang nội bộ</div>
        </div>
        <div style="text-align:right;font-size:0.78rem;color:var(--muted)">Backend auth</div>
      </div>

      <div style="margin-top:10px">
        <label for="username">Username</label>
        <input id="username" type="text" autocomplete="username" />
      </div>
      <div style="margin-top:12px">
        <label for="password">Password</label>
        <input id="password" type="password" autocomplete="current-password" />
      </div>

      <div style="margin-top:14px">
        <button id="loginBtn" class="btn">Login</button>
      </div>

      <div style="margin-top:12px;font-size:0.85rem;color:var(--muted)">
        Nếu quên tài khoản, hãy liên hệ admin nội bộ. Thông tin xác thực được kiểm tra ở backend qua API
        <code>/api/login</code>; không hiển thị trên trang này.
      </div>
    </div>
  </div>

  <script>
    // ==== CONFIG (đổi URL cho đúng) ====
    const API_URL      = "https://readhotmailbe.vercel.app/api/get_fb_code";
    const LOGIN_API_URL = "https://readhotmailbe.vercel.app/api/login";

    const SESSION_KEY = "readhotmail_logged_in";
    const TOKEN_KEY   = "readhotmail_token";

    // DOM
    const loginOverlay = document.getElementById("loginOverlay");
    const loginBtn     = document.getElementById("loginBtn");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");

    const appPanel     = document.getElementById("appPanel");
    const logoutBtn    = document.getElementById("logoutBtn");
    const newCredBtn   = document.getElementById("newCredBtn");
    const otpBannerWrap = document.getElementById("otpBannerWrap");
    const emailsWrap   = document.getElementById("emailsWrap");

    function isLoggedIn(){
      return sessionStorage.getItem(SESSION_KEY) === "1" &&
             !!sessionStorage.getItem(TOKEN_KEY);
    }
    function showApp(){
      loginOverlay.style.display = "none";
      appPanel.setAttribute("aria-hidden","false");
      logoutBtn.style.display = "inline-block";
      newCredBtn.style.display = "inline-block";
    }
    function showLogin(){
      loginOverlay.style.display = "flex";
      appPanel.setAttribute("aria-hidden","true");
      logoutBtn.style.display = "none";
      newCredBtn.style.display = "none";
    }

    if(isLoggedIn()) showApp(); else showLogin();

    // Login
    loginBtn.addEventListener("click", async () => {
      const u = (usernameInput.value||"").trim();
      const p = (passwordInput.value||"").trim();
      if(!u || !p){
        alert("Vui lòng nhập username & password");
        return;
      }
      loginBtn.disabled = true;
      loginBtn.textContent = "Đang login...";

      try {
        const res = await fetch(LOGIN_API_URL, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ username: u, password: p }),
        });
        const data = await res.json();
        if(!res.ok || !data.success){
          throw new Error(data.error || ("HTTP " + res.status));
        }
        sessionStorage.setItem(SESSION_KEY,"1");
        sessionStorage.setItem(TOKEN_KEY, data.token);
        showApp();
        setTimeout(()=> promptForCredential(), 320);
      } catch(err){
        console.error(err);
        alert("Login thất bại: " + err.message);
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = "Login";
      }
    });

    logoutBtn.addEventListener("click", () => {
      if(confirm("Đăng xuất?")){
        sessionStorage.removeItem(SESSION_KEY);
        sessionStorage.removeItem(TOKEN_KEY);
        otpBannerWrap.innerHTML = "";
        emailsWrap.innerHTML = "";
        showLogin();
      }
    });

    // Main flow
    async function promptForCredential(){
      const credential = window.prompt(
        "Nhập dòng credential (Username|Password|access_token|refresh_token|Client_id|Proxy)",
        ""
      );
      if(!credential) return;
      await callApiAndRender(credential);
    }

    newCredBtn.addEventListener("click", ()=>promptForCredential());
    appPanel.addEventListener("dblclick", ()=>promptForCredential());

    async function callApiAndRender(credentialStr){
      otpBannerWrap.innerHTML = "";
      emailsWrap.innerHTML = `<div class="small">Đang gọi API, vui lòng chờ...</div>`;
      try{
        const token = sessionStorage.getItem(TOKEN_KEY);
        if(!token) throw new Error("Chưa đăng nhập hoặc token đã mất.");
        const res = await fetch(API_URL, {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer "+token,
          },
          body: JSON.stringify({ credential: credentialStr }),
        });
        const data = await res.json();
        if(!res.ok || !data.success){
          const msg = (data && data.error) ? data.error : ("HTTP " + res.status);
          throw new Error(msg);
        }
        const emails = (data.emails || []).slice(0,3);
        const fb_code = data.fb_code || null;
        renderOtpBanner(fb_code);
        renderEmails(emails);
      }catch(err){
        console.error(err);
        otpBannerWrap.innerHTML =
          `<div class="otp-banner none" style="padding:12px">
             <div style="font-weight:700;color:var(--danger)">Lỗi</div>
             <div style="color:var(--muted);margin-left:10px">${escapeHtml(err.message)}</div>
           </div>`;
        emailsWrap.innerHTML = "";
      }
    }

    function renderOtpBanner(code){
      if(code){
        otpBannerWrap.innerHTML =
          `<div class="otp-banner success">
             <div style="font-size:0.95rem;font-weight:700">Mã bảo mật Facebook tìm thấy</div>
             <div class="code">${escapeHtml(code)}</div>
           </div>`;
      }else{
        otpBannerWrap.innerHTML =
          `<div class="otp-banner none">
             <div style="font-size:0.95rem;font-weight:700">Không có OTP Facebook</div>
             <div style="color:var(--muted);margin-left:8px">Không tìm thấy mã trong 3 email mới nhất</div>
           </div>`;
      }
    }

    function renderEmails(emails){
      if(!emails || emails.length===0){
        emailsWrap.innerHTML = `<div class="small">Không có email để hiển thị.</div>`;
        return;
      }
      emailsWrap.innerHTML = "";
      emails.forEach((m,idx)=>{
        const card = document.createElement("div");
        card.className="email-card";
        const subject = m.subject || "(Không có tiêu đề)";
        const fromName = m.from_name || m.from_addr || "(Không rõ)";
        const received = m.received || "";
        const preview = m.preview || "";
        card.innerHTML = `
          <div class="email-top">
            <div style="flex:1">
              <div class="subject">${idx+1}. ${escapeHtml(subject)}</div>
              <div class="meta">${escapeHtml(fromName)}${received ? " • "+escapeHtml(received) : ""}</div>
            </div>
            <div style="min-width:120px;text-align:right">
              <div class="small">#${idx+1}</div>
            </div>
          </div>
          <div class="preview">${escapeHtml(preview)}</div>
        `;
        emailsWrap.appendChild(card);
      });
    }

    function escapeHtml(s){
      if(!s && s!==0) return "";
      return String(s).replace(/[&<>"]/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"
      })[c]);
    }

    window.addEventListener("load", ()=>{
      if(isLoggedIn()){
        setTimeout(()=>{
          if(!emailsWrap.innerHTML || emailsWrap.innerHTML.trim()===""){
            promptForCredential();
          }
        },400);
      }
    });
  </script>
</body>
</html>
