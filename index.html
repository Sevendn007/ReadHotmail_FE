<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ReadHotmail Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg1:#e0e7ff;
  --bg2:#f0f9ff;
  --card:#ffffffcc;
  --accent:#2563eb;
  --accent-light:#3b82f6;
  --success:#10b981;
  --danger:#ef4444;
  font-family:'Inter',sans-serif;
}
html,body{
  margin:0;padding:0;height:100%;
  background:linear-gradient(135deg,var(--bg1),var(--bg2)),url('https://images.unsplash.com/photo-1531297484001-80022131f5a1?auto=format&fit=crop&w=1500&q=80') no-repeat center center fixed;
  background-size:cover;
  color:#0f172a;
}
.container{
  max-width:800px;margin:60px auto;padding:28px;
  background:var(--card);
  backdrop-filter:blur(10px);
  border-radius:20px;
  box-shadow:0 20px 50px rgba(15,23,42,0.2);
}
h1{margin-top:0;font-size:1.8rem;font-weight:700;text-align:center;color:var(--accent);}
h2{margin-bottom:8px;color:#0f172a;}
p{color:#475569;}

input[type="text"]{
  width:100%;padding:12px 14px;margin-top:8px;border-radius:10px;
  border:1px solid #cbd5e1;font-size:0.95rem;
}
button{
  background:var(--accent);color:white;border:none;padding:10px 20px;
  border-radius:10px;cursor:pointer;font-weight:600;
  box-shadow:0 6px 15px rgba(37,99,235,0.25);
}
button:hover{background:var(--accent-light);}
.small{font-size:0.85rem;color:#64748b;}
.flex{display:flex;align-items:center;gap:10px;}

.otp-banner{
  display:flex;align-items:center;gap:14px;
  border-radius:12px;padding:14px;margin:20px 0;
  font-weight:600;
}
.otp-banner.success{
  background:rgba(16,185,129,0.12);color:var(--success);
  border:1px solid rgba(16,185,129,0.2);
}
.otp-banner.none{
  background:rgba(239,68,68,0.08);color:var(--danger);
  border:1px solid rgba(239,68,68,0.1);
}
.emails{display:grid;gap:12px;margin-top:16px;}
.email-card{
  background:rgba(255,255,255,0.8);
  border-radius:12px;padding:14px 16px;
  display:flex;gap:12px;align-items:flex-start;
  border:1px solid rgba(15,23,42,0.08);
  box-shadow:0 6px 16px rgba(15,23,42,0.05);
}
.email-icon{
  width:36px;height:36px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  background:var(--accent);color:white;font-weight:700;font-size:1rem;
  flex-shrink:0;
}
.subject{font-weight:700;margin-bottom:4px;}
.meta{font-size:0.8rem;color:#6b7280;margin-bottom:4px;}
.preview{font-size:0.9rem;color:#334155;}
footer{margin-top:30px;text-align:center;font-size:0.8rem;color:#94a3b8;}
.login-card{
  max-width:420px;margin:80px auto;padding:24px 28px;
  background:var(--card);border-radius:16px;
  box-shadow:0 12px 35px rgba(15,23,42,0.2);
}
.login-card h2{text-align:center;margin-bottom:20px;}
</style>
</head>
<body>

<!-- Login -->
<div id="loginPanel" class="login-card" style="display:none;">
  <h2>ƒêƒÉng nh·∫≠p</h2>
  <label>Username</label>
  <input type="text" id="username" placeholder="Nh·∫≠p username" />
  <label style="margin-top:12px;">Password</label>
  <input type="password" id="password" placeholder="Nh·∫≠p password" />
  <div style="margin-top:16px;text-align:center;">
    <button id="loginBtn">Login</button>
  </div>
  <p class="small" style="margin-top:12px;text-align:center;">
    N·∫øu qu√™n t√†i kho·∫£n, li√™n h·ªá admin n·ªôi b·ªô.
  </p>
</div>

<!-- Main content -->
<div id="mainPanel" class="container" style="display:none;">
  <h1>üì¨ ReadHotmail Dashboard</h1>

  <div style="margin-bottom:14px;">
    <label for="credInput"><strong>Th√¥ng tin t√†i kho·∫£n Hotmail</strong></label>
    <input type="text" id="credInput" placeholder="Username|Password|access_token|refresh_token|Client_id|Proxy">
  </div>
  <div style="text-align:center;margin-bottom:20px;">
    <button id="fetchBtn">L·∫•y email</button>
    <button id="logoutBtn" style="margin-left:10px;background:#f43f5e;">Logout</button>
  </div>

  <div id="otpBanner"></div>
  <div id="emails" class="emails"></div>
  <footer>¬© 2025 ReadHotmail Internal Tool ‚Äî Ch·ªâ d√πng n·ªôi b·ªô.</footer>
</div>

<script>
const API_URL = "https://readhotmailbe.vercel.app/api/get_fb_code";
const LOGIN_API_URL = "https://readhotmailbe.vercel.app/api/login";
const SESSION_KEY="readhotmail_logged_in";
const TOKEN_KEY="readhotmail_token";

// DOM
const loginPanel=document.getElementById("loginPanel");
const mainPanel=document.getElementById("mainPanel");
const usernameInput=document.getElementById("username");
const passwordInput=document.getElementById("password");
const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");
const credInput=document.getElementById("credInput");
const fetchBtn=document.getElementById("fetchBtn");
const otpBanner=document.getElementById("otpBanner");
const emailsDiv=document.getElementById("emails");

function showLogin(){loginPanel.style.display="block";mainPanel.style.display="none";}
function showMain(){loginPanel.style.display="none";mainPanel.style.display="block";}
function isLoggedIn(){return sessionStorage.getItem(SESSION_KEY)==="1" && !!sessionStorage.getItem(TOKEN_KEY);}

if(isLoggedIn()) showMain(); else showLogin();

// login
loginBtn.addEventListener("click",async()=>{
  const u=usernameInput.value.trim(),p=passwordInput.value.trim();
  if(!u||!p){alert("Nh·∫≠p username & password");return;}
  loginBtn.disabled=true;loginBtn.textContent="ƒêang login...";
  try{
    const res=await fetch(LOGIN_API_URL,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({username:u,password:p})
    });
    const data=await res.json();
    if(!res.ok||!data.success) throw new Error(data.error||("HTTP "+res.status));
    sessionStorage.setItem(SESSION_KEY,"1");
    sessionStorage.setItem(TOKEN_KEY,data.token);
    showMain();
  }catch(e){alert("Login l·ªói: "+e.message);}finally{
    loginBtn.disabled=false;loginBtn.textContent="Login";
  }
});

// logout
logoutBtn.addEventListener("click",()=>{
  sessionStorage.clear();showLogin();
});

// fetch emails
fetchBtn.addEventListener("click",async()=>{
  const cred=credInput.value.trim();
  if(!cred){alert("Vui l√≤ng nh·∫≠p credential Hotmail");return;}
  otpBanner.innerHTML="";emailsDiv.innerHTML="<p>‚è≥ ƒêang t·∫£i...</p>";
  try{
    const token=sessionStorage.getItem(TOKEN_KEY);
    if(!token) throw new Error("Ch∆∞a ƒëƒÉng nh·∫≠p.");
    const res=await fetch(API_URL,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer "+token
      },
      body:JSON.stringify({credential:cred})
    });
    const data=await res.json();
    if(!res.ok||!data.success)
      throw new Error(data.error||("HTTP "+res.status));
    renderOtp(data.fb_code);
    renderEmails(data.emails||[]);
  }catch(e){
    otpBanner.innerHTML=`<div class="otp-banner none">‚ö†Ô∏è ${e.message}</div>`;
    emailsDiv.innerHTML="";
  }
});

function renderOtp(code){
  if(code){
    otpBanner.innerHTML=`<div class="otp-banner success">üîë M√£ b·∫£o m·∫≠t Facebook: <span class="code">${code}</span></div>`;
  }else{
    otpBanner.innerHTML=`<div class="otp-banner none">‚ùå Kh√¥ng c√≥ OTP Facebook trong 3 email m·ªõi nh·∫•t</div>`;
  }
}

function renderEmails(list){
  if(!list.length){emailsDiv.innerHTML="<p>Kh√¥ng c√≥ email n√†o.</p>";return;}
  emailsDiv.innerHTML="";
  list.slice(0,3).forEach((m,i)=>{
    const icon=m.from_name?m.from_name.charAt(0).toUpperCase():"‚úâÔ∏è";
    const el=document.createElement("div");
    el.className="email-card";
    el.innerHTML=`
      <div class="email-icon">${icon}</div>
      <div style="flex:1">
        <div class="subject">${i+1}. ${escapeHtml(m.subject||"(Kh√¥ng c√≥ ti√™u ƒë·ªÅ)")}</div>
        <div class="meta">${escapeHtml(m.from_name||m.from_addr||"")} ${m.received?("‚Ä¢ "+escapeHtml(m.received)):""}</div>
        <div class="preview">${escapeHtml(m.preview||"")}</div>
      </div>
    `;
    emailsDiv.appendChild(el);
  });
}

function escapeHtml(s){return String(s).replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));}
</script>
</body>
</html>
